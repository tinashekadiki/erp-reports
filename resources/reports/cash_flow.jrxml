<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="StatementOfCashFlows_Indirect" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="d6e87295-d602-4632-9653-53d7119e88d6">
	<parameter name="date_from" class="java.lang.String"/>
	<parameter name="date_to" class="java.lang.String"/>
	<parameter name="company_name" class="java.lang.String"/>
	<parameter name="company_address" class="java.lang.String"/>
	<parameter name="financial_year" class="java.lang.String"/>
	<parameter name="print_details" class="java.lang.String"/>
	<parameter name="sort_by" class="java.lang.String"/>
	<parameter name="display_format" class="java.lang.String"/>
	<parameter name="suppress_zero" class="java.lang.Boolean"/>
	<parameter name="include_ytd" class="java.lang.Boolean"/>
	<parameter name="include_budget" class="java.lang.Boolean"/>
	<parameter name="print_assets_first" class="java.lang.Boolean"/>
	<parameter name="logo" class="java.lang.String"/>
	<queryString>
		<![CDATA[-- 1. Surplus / (Deficit)
        SELECT 
            'Operating Activities' as activity_type,
            1 as section_order,
            'Surplus / (Deficit) for the period' as description,
            SUM(CASE WHEN fcc.name = 'Revenue' THEN (gj.credit - gj.debit) ELSE -(gj.debit - gj.credit) END) as amount
        FROM general_journals gj
        JOIN votes v ON gj.vote_id = v.id
        JOIN financial_category_classes fcc ON v.financial_category_class_id = fcc.id
        WHERE gj.trans_date BETWEEN $P{date_from} AND $P{date_to}
        AND fcc.name IN ('Revenue', 'Expenses', 'Cost of Sales')

        UNION ALL

        -- 2. Working Capital: Current Assets (excluding Cash)
        SELECT 
            'Operating Activities' as activity_type,
            2 as section_order,
            'Movement in ' || fc.name as description,
            -( (SUM(CASE WHEN gj.trans_date <= $P{date_to} THEN gj.debit - gj.credit ELSE 0 END)) - 
               (SUM(CASE WHEN gj.trans_date < $P{date_from} THEN gj.debit - gj.credit ELSE 0 END)) ) as amount
        FROM general_journals gj
        JOIN votes v ON gj.vote_id = v.id
        JOIN financial_categories fc ON v.financial_category_id = fc.id
        JOIN financial_category_classes fcc ON v.financial_category_class_id = fcc.id
        WHERE fcc.name = 'Assets' 
        AND fc.name LIKE '%Current%' 
        AND fc.name NOT LIKE '%Cash%' AND fc.name NOT LIKE '%Bank%'
        GROUP BY fc.name

        UNION ALL

        -- 3. Working Capital: Current Liabilities
        SELECT 
            'Operating Activities' as activity_type,
            3 as section_order,
            'Movement in ' || fc.name as description,
            ( (SUM(CASE WHEN gj.trans_date <= $P{date_to} THEN gj.credit - gj.debit ELSE 0 END)) - 
              (SUM(CASE WHEN gj.trans_date < $P{date_from} THEN gj.credit - gj.debit ELSE 0 END)) ) as amount
        FROM general_journals gj
        JOIN votes v ON gj.vote_id = v.id
        JOIN financial_categories fc ON v.financial_category_id = fc.id
        JOIN financial_category_classes fcc ON v.financial_category_class_id = fcc.id
        WHERE fcc.name = 'Liabilities' 
        AND fc.name LIKE '%Current%'
        GROUP BY fc.name

        UNION ALL

        -- 4. Investing Activities (Non-Current Assets)
        SELECT 
            'Investing Activities' as activity_type,
            4 as section_order,
            'Movement in ' || fc.name as description,
            -( (SUM(CASE WHEN gj.trans_date <= $P{date_to} THEN gj.debit - gj.credit ELSE 0 END)) - 
               (SUM(CASE WHEN gj.trans_date < $P{date_from} THEN gj.debit - gj.credit ELSE 0 END)) ) as amount
        FROM general_journals gj
        JOIN votes v ON gj.vote_id = v.id
        JOIN financial_categories fc ON v.financial_category_id = fc.id
        JOIN financial_category_classes fcc ON v.financial_category_class_id = fcc.id
        WHERE fcc.name = 'Assets' 
        AND fc.name LIKE '%Non Current%'
        GROUP BY fc.name

        UNION ALL

        -- 5. Financing Activities (Equity & Non-Current Liabilities)
        SELECT 
            'Financing Activities' as activity_type,
            5 as section_order,
            'Movement in ' || fc.name as description,
            ( (SUM(CASE WHEN gj.trans_date <= $P{date_to} THEN gj.credit - gj.debit ELSE 0 END)) - 
              (SUM(CASE WHEN gj.trans_date < $P{date_from} THEN gj.credit - gj.debit ELSE 0 END)) ) as amount
        FROM general_journals gj
        JOIN votes v ON gj.vote_id = v.id
        JOIN financial_categories fc ON v.financial_category_id = fc.id
        JOIN financial_category_classes fcc ON v.financial_category_class_id = fcc.id
        WHERE fcc.name IN ('Equity', 'Liabilities') 
        AND (fcc.name = 'Equity' OR fc.name LIKE '%Non Current%')
        GROUP BY fc.name

        ORDER BY section_order ASC]]>
	</queryString>
	<field name="activity_type" class="java.lang.String"/>
	<field name="description" class="java.lang.String"/>
	<field name="amount" class="java.math.BigDecimal"/>
	<variable name="activity_total" class="java.math.BigDecimal" resetType="Group" resetGroup="ActivityGroup" calculation="Sum">
		<variableExpression><![CDATA[$F{amount}]]></variableExpression>
	</variable>
	<variable name="net_cash_movement" class="java.math.BigDecimal" calculation="Sum">
		<variableExpression><![CDATA[$F{amount}]]></variableExpression>
	</variable>
	<group name="ActivityGroup">
		<groupExpression><![CDATA[$F{activity_type}]]></groupExpression>
		<groupHeader>
			<band height="30">
				<textField>
					<reportElement x="0" y="10" width="555" height="20" forecolor="#006699" uuid="2b194fb8-17a4-4a24-9b84-47a32332677e"/>
					<textElement><font size="12" isBold="true"/></textElement>
					<textFieldExpression><![CDATA[$F{activity_type}.toUpperCase()]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="30">
				<textField pattern="#,##0.00;(#,##0.00)">
					<reportElement x="445" y="5" width="100" height="20" uuid="3b194fb8-17a4-4a24-9b84-47a32332677e"/>
					<textElement textAlignment="Right"><font isBold="true"/></textElement>
					<textFieldExpression><![CDATA[$V{activity_total}]]></textFieldExpression>
				</textField>
				<textField>
					<reportElement x="245" y="5" width="200" height="20" uuid="4b194fb8-17a4-4a24-9b84-47a32332677e"/>
					<textElement textAlignment="Right"><font isBold="true"/></textElement>
					<textFieldExpression><![CDATA["Net Cash flow from " + $F{activity_type}]]></textFieldExpression>
				</textField>
				<line>
					<reportElement x="350" y="0" width="200" height="1" uuid="5b194fb8-17a4-4a24-9b84-47a32332677e"/>
				</line>
			</band>
		</groupFooter>
	</group>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="90" splitType="Stretch">
			<textField>
				<reportElement x="0" y="0" width="555" height="25" uuid="b194fb84-17a4-4a24-9b84-47a32332677e"/>
				<textElement textAlignment="Center"><font size="16" isBold="true"/></textElement>
				<textFieldExpression><![CDATA[$P{company_name}]]></textFieldExpression>
			</textField>
			<image scaleImage="RetainShape" hAlign="Left" vAlign="Top">
				<reportElement x="0" y="0" width="80" height="50" uuid="a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"/>
				<imageExpression><![CDATA[$P{logo}]]></imageExpression>
			</image>
			<staticText>
				<reportElement x="0" y="25" width="555" height="20" forecolor="#006699" uuid="55581e22-cc43-4e6f-870b-47e09156ea36"/>
				<textElement textAlignment="Center"><font size="12" isBold="true"/></textElement>
				<text><![CDATA[Statement of Cash Flows (Indirect Method - IAS 7)]]></text>
			</staticText>
			<textField>
				<reportElement x="0" y="45" width="555" height="15" uuid="93421e42-cc43-4e6f-870b-47e09156ea36"/>
				<textElement textAlignment="Center"><font size="9"/></textElement>
				<textFieldExpression><![CDATA["For the period: " + $P{date_from} + " to " + $P{date_to}]]></textFieldExpression>
			</textField>
		</band>
	</title>
	<detail>
		<band height="18" splitType="Stretch">
			<textField isStretchWithOverflow="true">
				<reportElement x="30" y="0" width="415" height="18" uuid="33421e42-cc43-4e6f-870b-47e09156ea36"/>
				<textElement><font size="9"/></textElement>
				<textFieldExpression><![CDATA[$F{description}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0.00;(#,##0.00)">
				<reportElement x="445" y="0" width="100" height="18" uuid="43421e42-cc43-4e6f-870b-47e09156ea36"/>
				<textElement textAlignment="Right"><font size="9"/></textElement>
				<textFieldExpression><![CDATA[$F{amount}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<pageFooter>
		<band height="35" splitType="Stretch">
			<textField>
				<reportElement x="380" y="10" width="175" height="15" forecolor="#999999" uuid="63421e42-cc43-4e6f-870b-47e09156ea36"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA["Page " + $V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField pattern="dd/MM/yyyy HH:mm">
				<reportElement x="0" y="10" width="175" height="15" forecolor="#999999" uuid="73421e42-cc43-4e6f-870b-47e09156ea36"/>
				<textElement textAlignment="Left" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<textFieldExpression><![CDATA["Generated on: " + new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="175" y="10" width="205" height="15" forecolor="#999999" uuid="83421e42-cc43-4e6f-870b-47e09156ea36"/>
				<textElement textAlignment="Center" verticalAlignment="Middle">
					<font size="8"/>
				</textElement>
				<text><![CDATA[(c) Zenue Systems 2026 for Ndarama ERP]]></text>
			</staticText>
		</band>
	</pageFooter>
	<summary>
		<band height="60">
			<line>
				<reportElement x="350" y="10" width="205" height="1" uuid="d9342142-cc43-4e6f-870b-47e09156ea39"/>
			</line>
			<staticText>
				<reportElement x="145" y="15" width="300" height="25" uuid="13421e42-cc43-4e6f-870b-47e09156ea37"/>
				<textElement textAlignment="Right" verticalAlignment="Middle"><font size="11" isBold="true"/></textElement>
				<text><![CDATA[NET INCREASE / (DECREASE) IN CASH:]]></text>
			</staticText>
			<textField pattern="#,##0.00;(#,##0.00)">
				<reportElement x="445" y="15" width="100" height="25" uuid="43421e42-cc43-4e6f-870b-47e09156ea37"/>
				<textElement textAlignment="Right" verticalAlignment="Middle"><font size="11" isBold="true"/></textElement>
				<textFieldExpression><![CDATA[$V{net_cash_movement}]]></textFieldExpression>
			</textField>
			<line>
				<reportElement x="350" y="45" width="205" height="2" uuid="d9342142-cc43-4e6f-870b-47e09156ea40"/>
			</line>
		</band>
	</summary>
</jasperReport>
